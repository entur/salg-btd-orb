description: "Sends slack message."
steps:
  - checkout
  - run:
      command: |-
        GRADLE_VERSION=$(cat ./gradle.properties | grep "version" | cut -d'=' -f2)
        echo $GRADLE_VERSION
        echo "export GRADLE_VERSION=$GRADLE_VERSION" >> $BASH_ENV
        CURRENT_TAG=master-v$GRADLE_VERSION
        echo $CURRENT_TAG
        echo "export CURRENT_TAG=$CURRENT_TAG" >> $BASH_ENV
        echo $CURRENT_TAG
        ISSUE_KEYS=$(git log --pretty=oneline ${CURRENT_TAG}..HEAD | \
        grep -e '[A-Z]\+-[0-9]\+' -o | uniq | sed -e "H;\${x;s/\n/,/g;s/^,//;p;};d")
        echo $ISSUE_KEYS
        echo "export ISSUE_KEYS=${ISSUE_KEYS:None}" >> $BASH_ENV
        cat $BASH_ENV
  - slack/notify:
      event: fail
      custom: |-
        {
            "attachments": [
              {
                "color": "#d31b1b",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Your job ${CIRCLE_JOB} has failed :x:*"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*: \n $CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*: \n $CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*: \n $CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Commit*: \n $ISSUE_KEYS"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
            ]
          }
